# üî¨ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SSIM –∞–Ω–∞–ª–∏–∑–∞ –≤ new_detect_1_2.py

## ‚úÖ –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:

### 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—Ç—è–Ω—É—Ç—ã—Ö –ø–ª–∞—Ç –≤ `small_photos/`

–ü–æ—Å–ª–µ —Ä–∞—Å—Ç—è–∂–µ–Ω–∏—è –ø–ª–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:
- `small_photos/reference_rectified.jpg` - —ç—Ç–∞–ª–æ–Ω–Ω–∞—è –ø–ª–∞—Ç–∞
- `small_photos/test_rectified.jpg` - —Ç–µ—Å—Ç–æ–≤–∞—è –ø–ª–∞—Ç–∞

### 2. SSIM –∞–Ω–∞–ª–∏–∑ –¥–µ—Ñ–µ–∫—Ç–æ–≤

–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–ª–≥–æ—Ä–∏—Ç–º –∏–∑ `diff_ssim.py`:
- –†–∞–∑–±–∏–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –±–ª–æ–∫–∏ 16√ó16
- –í—ã—á–∏—Å–ª—è–µ—Ç SSIM –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞
- –ù–∞—Ö–æ–¥–∏—Ç –¥–µ—Ñ–µ–∫—Ç—ã (SSIM < 0.75)
- –°–æ–∑–¥–∞–µ—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ SSIM

- `small_photos/ssim_result_with_boxes.jpg` - —Ç–µ—Å—Ç–æ–≤–∞—è –ø–ª–∞—Ç–∞ —Å –∫—Ä–∞—Å–Ω—ã–º–∏ —Ä–∞–º–∫–∞–º–∏ –≤–æ–∫—Ä—É–≥ –¥–µ—Ñ–µ–∫—Ç–æ–≤
- `small_photos/ssim_defects_only.jpg` - —Ç–æ–ª—å–∫–æ –¥–µ—Ñ–µ–∫—Ç–Ω—ã–µ –±–ª–æ–∫–∏ –Ω–∞ –±–µ–ª–æ–º —Ñ–æ–Ω–µ

## üìä –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:

```
üíæ –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ê–°–¢–Ø–ù–£–¢–´–• –ü–õ–ê–¢
----------------------------------------------------------------------
‚úì –≠—Ç–∞–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω: small_photos/reference_rectified.jpg
‚úì –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: small_photos/test_rectified.jpg

üìä –≠–¢–ê–ü 5: –°–†–ê–í–ù–ï–ù–ò–ï –ü–õ–ê–¢
----------------------------------------------------------------------
=== –°–†–ê–í–ù–ï–ù–ò–ï –ü–õ–ê–¢ ===
–°—Ä–µ–¥–Ω—è—è —Ä–∞–∑–Ω–∏—Ü–∞: 0.0234
–ú–∞–∫—Å. —Ä–∞–∑–Ω–∏—Ü–∞: 0.8923
–î–æ–ª—è –ø–∏–∫—Å–µ–ª–µ–π > 0.1: 12.34%

=== –°–†–ê–í–ù–ï–ù–ò–ï –ü–û –°–ï–¢–ö–ï ===
–°–µ–≥–º–µ–Ω—Ç–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏: 389 / 400
–î–µ—Ñ–µ–∫—Ç–Ω—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (> 0.07): 47

üî¨ SSIM –ê–ù–ê–õ–ò–ó –î–ï–§–ï–ö–¢–û–í
----------------------------------------------------------------------
‚úì –ù–∞–π–¥–µ–Ω–æ –¥–µ—Ñ–µ–∫—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (SSIM): 23
‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç —Å –æ–±–≤–æ–¥–∫–æ–π: small_photos/ssim_result_with_boxes.jpg
‚úì –¢–æ–ª—å–∫–æ –¥–µ—Ñ–µ–∫—Ç—ã: small_photos/ssim_defects_only.jpg

–î–µ—Ç–∞–ª–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤:
  #1: –ø–æ–∑–∏—Ü–∏—è (128, 256), SSIM=0.652, diff_pixels=78
  #2: –ø–æ–∑–∏—Ü–∏—è (144, 256), SSIM=0.701, diff_pixels=65
  #3: –ø–æ–∑–∏—Ü–∏—è (160, 272), SSIM=0.689, diff_pixels=71
  #4: –ø–æ–∑–∏—Ü–∏—è (176, 288), SSIM=0.723, diff_pixels=58
  #5: –ø–æ–∑–∏—Ü–∏—è (192, 304), SSIM=0.698, diff_pixels=69
  ... –∏ –µ—â–µ 18 –±–ª–æ–∫–æ–≤
```

## üéØ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã SSIM:

–í —Ñ—É–Ω–∫—Ü–∏–∏ `compare_images_with_ssim` (—Å—Ç—Ä–æ–∫–∞ ~1503):

```python
result_with_boxes, defects_only, defect_blocks = compare_images_with_ssim(
    ref_pil, test_pil,
    block_size=16,      # –†–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ (16√ó16 –ø–∏–∫—Å–µ–ª–µ–π)
    diff_thresh=30,     # –ü–æ—Ä–æ–≥ —Ä–∞–∑–ª–∏—á–∏–π –ø–∏–∫—Å–µ–ª–µ–π (0-255)
    ssim_thresh=0.75    # –ü–æ—Ä–æ–≥ SSIM (0-1, –Ω–∏–∂–µ = –¥–µ—Ñ–µ–∫—Ç)
)
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

**block_size** - —Ä–∞–∑–º–µ—Ä –±–ª–æ–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
- `8` - –º–µ–ª–∫–∏–µ –±–ª–æ–∫–∏, –æ—á–µ–Ω—å –¥–µ—Ç–∞–ª—å–Ω–æ
- `16` - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- `32` - –∫—Ä—É–ø–Ω—ã–µ –±–ª–æ–∫–∏, –±—ã—Å—Ç—Ä–µ–µ

**diff_thresh** - –ø–æ—Ä–æ–≥ —Ä–∞–∑–ª–∏—á–∏–π –ø–∏–∫—Å–µ–ª–µ–π:
- `20` - –±–æ–ª–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ
- `30` - —Å—Ç–∞–Ω–¥–∞—Ä—Ç
- `40` - –º–µ–Ω–µ–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ

**ssim_thresh** - –ø–æ—Ä–æ–≥ SSIM:
- `0.9` - —Ç–æ–ª—å–∫–æ –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏–µ –±–ª–æ–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –Ω–æ—Ä–º–æ–π (–±–æ–ª—å—à–µ –¥–µ—Ñ–µ–∫—Ç–æ–≤)
- `0.75` - —Å—Ç–∞–Ω–¥–∞—Ä—Ç
- `0.6` - —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã

## üÜö –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤:

| –ú–µ—Ç–æ–¥ | –ß—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç | –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ | –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ |
|-------|-------------|--------------|------------|
| **–ü–æ–ø–∏–∫—Å–µ–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ** | –¢–æ—á–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –ø–∏–∫—Å–µ–ª–µ–π | –ë—ã—Å—Ç—Ä–æ, –ø—Ä–æ—Å—Ç–æ | –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ —à—É–º—É |
| **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ —Å–µ—Ç–∫–µ** | –°—Ä–µ–¥–Ω–∏–µ —Ä–∞–∑–ª–∏—á–∏—è –≤ –æ–±–ª–∞—Å—Ç—è—Ö | –†–æ–±–∞—Å—Ç–Ω–æ –∫ —à—É–º—É | –ú–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –º–µ–ª–∫–∏–µ –¥–µ—Ñ–µ–∫—Ç—ã |
| **SSIM –∞–Ω–∞–ª–∏–∑** | –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è | –£—á–∏—Ç—ã–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ | –ú–µ–¥–ª–µ–Ω–Ω–µ–µ |

## üí° –ö–æ–≥–¥–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

### –ü–æ–ø–∏–∫—Å–µ–ª—å–Ω–æ–µ (`compare_pcb_regions`):
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è –æ—Ü–µ–Ω–∫–∞
- ‚úÖ –¢–æ—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- ‚ùå –®—É–º–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü–æ —Å–µ—Ç–∫–µ (`compare_pcb_by_grid`):
- ‚úÖ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤
- ‚úÖ –†–æ–±–∞—Å—Ç–Ω–æ—Å—Ç—å –∫ —à—É–º—É
- ‚úÖ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ

### SSIM (`compare_images_with_ssim`):
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ
- ‚úÖ –¢–æ—á–Ω–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏ small_photos:

```
small_photos/
‚îú‚îÄ‚îÄ reference_rectified.jpg       # –≠—Ç–∞–ª–æ–Ω (—Ä–∞—Å—Ç—è–Ω—É—Ç—ã–π)
‚îú‚îÄ‚îÄ test_rectified.jpg             # –¢–µ—Å—Ç (—Ä–∞—Å—Ç—è–Ω—É—Ç—ã–π)
‚îú‚îÄ‚îÄ ssim_result_with_boxes.jpg     # –¢–µ—Å—Ç —Å –∫—Ä–∞—Å–Ω—ã–º–∏ —Ä–∞–º–∫–∞–º–∏ –¥–µ—Ñ–µ–∫—Ç–æ–≤
‚îî‚îÄ‚îÄ ssim_defects_only.jpg          # –¢–æ–ª—å–∫–æ –¥–µ—Ñ–µ–∫—Ç—ã –Ω–∞ –±–µ–ª–æ–º —Ñ–æ–Ω–µ
```

## üîß –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏:

```python
# 1. –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –ø–ª–∞—Ç—ã
reference_pcb_region, test_pcb_region = rectify_pcb_to_corners(...)

# 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ small_photos/
Image.fromarray(ref_save).save("small_photos/reference_rectified.jpg")
Image.fromarray(test_save).save("small_photos/test_rectified.jpg")

# 3. –ü—Ä–∏–º–µ–Ω—è–µ–º 3 –º–µ—Ç–æ–¥–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
#    a) –ü–æ–ø–∏–∫—Å–µ–ª—å–Ω–æ–µ
stats = compare_pcb_regions(reference_pcb_region, test_pcb_region)

#    b) –ü–æ —Å–µ—Ç–∫–µ
grid_info = compare_pcb_by_grid(reference_pcb_region, test_pcb_region)

#    c) SSIM (–∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤)
result, defects, blocks = compare_images_with_ssim(ref_pil, test_pil)

# 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã SSIM
result.save("small_photos/ssim_result_with_boxes.jpg")
defects.save("small_photos/ssim_defects_only.jpg")
```

## üé® –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è SSIM:

### ssim_result_with_boxes.jpg:
- –¢–µ—Å—Ç–æ–≤–∞—è –ø–ª–∞—Ç–∞
- –ö—Ä–∞—Å–Ω—ã–µ —Ä–∞–º–∫–∏ –≤–æ–∫—Ä—É–≥ –¥–µ—Ñ–µ–∫—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–æ–≤

### ssim_defects_only.jpg:
- –ë–µ–ª—ã–π —Ñ–æ–Ω
- –¢–æ–ª—å–∫–æ –¥–µ—Ñ–µ–∫—Ç–Ω—ã–µ –±–ª–æ–∫–∏ –≤ —Ü–≤–µ—Ç–µ
- –£–¥–æ–±–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```bash
python3 new_detect_1_2.py
```

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:
1. –ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç –≤—Å–µ —ç—Ç–∞–ø—ã
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç —Ä–∞—Å—Ç—è–Ω—É—Ç—ã–µ –ø–ª–∞—Ç—ã –≤ `small_photos/`
3. –í—ã–ø–æ–ª–Ω–∏—Ç 3 –º–µ—Ç–æ–¥–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã SSIM
5. –ü–æ–∫–∞–∂–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∏

## üìä –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:

### SSIM –∑–Ω–∞—á–µ–Ω–∏—è:
- `1.0` - –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –±–ª–æ–∫–∏
- `0.9-1.0` - –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–∏
- `0.75-0.9` - –ø–æ—Ö–æ–∂–∏ (–Ω–æ—Ä–º–∞)
- `0.6-0.75` - –∑–∞–º–µ—Ç–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è
- `< 0.6` - –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è (–¥–µ—Ñ–µ–∫—Ç)

### diff_pixels:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∏–∫—Å–µ–ª–µ–π —Å —Ä–∞–∑–ª–∏—á–∏–µ–º > diff_thresh
- –ß–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –¥–µ—Ñ–µ–∫—Ç

## üí° –°–æ–≤–µ—Ç—ã:

1. **–î–ª—è –º–µ–ª–∫–∏—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤**: `block_size=8, ssim_thresh=0.8`
2. **–î–ª—è –∫—Ä—É–ø–Ω—ã—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤**: `block_size=32, ssim_thresh=0.7`
3. **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**: `block_size=16, ssim_thresh=0.75`

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≥—Ä–∞–º–º–∞:
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–∞—Å—Ç—è–Ω—É—Ç—ã–µ –ø–ª–∞—Ç—ã
- ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ—Ç 3 –º–µ—Ç–æ–¥–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç SSIM –∏–∑ `diff_ssim.py`
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ –í—ã–≤–æ–¥–∏—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–µ—Ñ–µ–∫—Ç–æ–≤

```bash
python3 new_detect_1_2.py
```

